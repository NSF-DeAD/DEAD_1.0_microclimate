---
title: "L2_Kestrel_data_plots"
author: "Heather Throop"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

## Overview

This is a synthesis of Kestrel logger data for the DEAD project. Loggers were deployed in March 2021 and collected in end of October or early November 2022. Prior R script in this project combines and synthesizes data starting with the first logger downloads. Summary plots for microsites and sites are plotted.

This code pulls data from the Dropbox folder using a config.yml file that maps to the Dropbox folder ("\~/DeAD NSF MSB Dryland Decomposition/Field&LabCircle/DEAD1_0/logger_data"). Data are written the same way.

Written July 24, 2023 updated 2023-07-25, 2025-01-30, 2026-01-21\
Heather Throop

```{r}
#|label: Load-packages
library(scales)
library(tidyverse)
library(lubridate)
library(reshape2)
library(hms)

sessionInfo()
```

```{r}
# Use the stored config file to define the path for the DeAD Dropbox folder
DEADloggers <- config::get()
```

# Data Read

## List Kestrel Files for Reading In

*Note that this pulls the L2 csv file from Dropbox. Check that the most recent file is called.*

```{r}
#|label: Read-and-clean-L2-data

# read in the combined L2 dataset (all sites, all times, all microsites)
L2_cleaning = read.csv(file = file.path(DEADloggers,  "DEAD_Kestrel_L2.csv"))

# check the loggers that we have (there should be 51)
L2_cleaning |>
  group_by(site, loggerID) |>
  summarize(n=n())

# Data clean-up 
# remove the extra columns that gets added in (columns "X" and "...1")
L2_cleaning <- L2_cleaning[, -c(1)]
# make LoggerID treated as categorical (factor) rather than continuous variable
L2_cleaning$loggerID <- as.factor(L2_cleaning$loggerID) 

# Pull out date and time from the datetime stamp
L2_cleaning$datetime <- as.POSIXct(L2_cleaning$datetime, format = "%Y-%m-%d %H:%M:%S")
# extract the date out of the datetime stamp
L2_cleaning$date <- as.Date(L2_cleaning$datetime) 
# extract HMS out of the datetime stamp
L2_cleaning$HMS <- format(L2_cleaning$datetime, format = "%H:%M:%S")

L2_clean <- L2_cleaning 
```

# Site x Microsite Means

```{r}
#| label: hourly site-x-microsite-means
# create df that condenses the multiple loggers per site x microsite condition down to one mean value per hour

KestrelL2_hourlymeans_df <- L2_clean |>
  group_by(site, microsite, datetime) |>
  summarize(
               N    = sum(!is.na(RH)),
               mean_T = mean(temperature, na.rm=TRUE),
               sd_T   = sd(temperature, na.rm=TRUE),
               se_T   = sd_T / sqrt(N),
               mean_RH = mean(RH, na.rm=TRUE),
               sd_RH   = sd(RH, na.rm=TRUE),
               se_RH   = sd_RH / sqrt(N)
               ) |>
  na.omit(KestrelL2_hourlymeans_df)


```

```{r}
#| label: daily-site-microsite means
# create df that condenses the multiple loggers per site x microsite condition down to one mean value day

KestrelL2_hourlymeans_df$date <- as.Date(KestrelL2_hourlymeans_df$datetime) # extract the date out of the datetime stamp

KestrelL2_dailymeans_df <- KestrelL2_hourlymeans_df |>
  group_by(site, microsite, date) |>
  summarize(
              N    = sum(!is.na(mean_RH)),
              dailyT = mean(mean_T, na.rm=TRUE),
              sd_dailyT   = sd(mean_T, na.rm=TRUE),
              se_dailyT   = sd_dailyT / sqrt(N),
              dailyRH = mean(mean_RH, na.rm=TRUE),
              sd_dailyRH   = sd(mean_RH, na.rm=TRUE),
              se_dailyRH   = sd_dailyRH / sqrt(N),
              dailyminRH = min(mean_RH, na.rm=TRUE),
              dailymaxRH = max(mean_RH, na.rm=TRUE),
              daily_max_T = max(mean_T, na.rm=TRUE),
              daily_min_T = min(mean_T, na.rm=TRUE)
              )

# plots of daily means
p2 <- ggplot(KestrelL2_dailymeans_df, aes(x=date, y=dailyRH, color = microsite, group = 1)) + 
  geom_point() +
  theme_bw() +
  ylab("Daily Mean Relative Humidity (%)") +
  xlab("") +
  scale_x_date(limits = as.Date(c("2021-03-01", "2022-11-01")))
p2 + facet_grid(site ~ .)

p2max <- ggplot(KestrelL2_dailymeans_df, aes(x=date, y=dailymaxRH, color = microsite, group = 1)) + 
  geom_point() +
  theme_bw() +
  ylab("Daily Maximum Relative Humidity (%)") +
  xlab("") +
  scale_x_date(limits = as.Date(c("2021-03-01", "2022-11-01")))
p2max + facet_grid(site ~ .)

p2min <- ggplot(KestrelL2_dailymeans_df, aes(x=date, y=dailyminRH, color = microsite, group = 1)) + 
  geom_point() +
  theme_bw() +
  ylab("Daily Minimum Relative Humidity (%)") +
  xlab("") +
  scale_x_date(limits = as.Date(c("2021-03-01", "2022-11-01")))
p2min + facet_grid(site ~ .)

p3 <- ggplot(KestrelL2_dailymeans_df, aes(x=date, y=dailyT, color = microsite, group = 1)) + 
  geom_point() +
  theme_bw() +
  ylab("Daily Mean Temperature (C)") +
  xlab("") +
  scale_x_date(limits = as.Date(c("2021-03-01", "2022-11-01")))
p3 + facet_grid(site ~ .) 

p3max <- ggplot(KestrelL2_dailymeans_df, aes(x=date, y=daily_max_T, color = microsite, group = 1)) + 
  geom_point() +
  theme_bw() +
  ylab("Daily Max Temperature (C)") +
  xlab("") +
  scale_x_date(limits = as.Date(c("2021-03-01", "2022-11-01")))
p3max + facet_grid(site ~ .) 

p3min <- ggplot(KestrelL2_dailymeans_df, aes(x=date, y=daily_min_T, color = microsite, group = 1)) + 
  geom_point() +
  theme_bw() +
  ylab("Daily Min Temperature (C)") +
  xlab("") +
  scale_x_date(limits = as.Date(c("2021-03-01", "2022-11-01")))
p3min + facet_grid(site ~ .) 

```

# Microsite Comparisons

```{r}
# read in the combined L2 dataset (all sites, all times, all microsites)

# plot T each hour by site, comparing microsites
p <- ggplot(KestrelL2_hourlymeans_df, aes(x=datetime, y=mean_T, color = microsite)) + geom_line() +
  labs(title = "") +
  xlab("Date") +
  ylab("Temperature (C)") +
  scale_x_datetime(date_breaks = "2 week", labels = date_format("%b %d"))
p + facet_grid(site ~ .)

# plot RH each hour by site, comparing microsites
p <- ggplot(KestrelL2_hourlymeans_df, aes(x=datetime, y=mean_RH, color = microsite)) + geom_line() +
  labs(title = "") +
  xlab("Date") +
  ylab("RH (%)") +
  scale_x_datetime(date_breaks = "2 week", labels = date_format("%b %d"))
p + facet_grid(site ~ .)

# convert from long to wide form to calculate differences between microsites at a given time
microsite_diff_df <- KestrelL2_hourlymeans_df %>% 
  select(site, microsite, datetime, mean_T,mean_RH) %>%
  pivot_wider(names_from=c(microsite), 
              values_from=c(mean_T, mean_RH)) 

microsite_diff_df$shrub.openT <- microsite_diff_df$mean_T_Shrub - microsite_diff_df$mean_T_Open  
microsite_diff_df$shrub.openRH <- microsite_diff_df$mean_RH_Shrub - microsite_diff_df$mean_RH_Open 

# plot shrub minus open T by site
p <- ggplot(microsite_diff_df, aes(x=datetime, y=shrub.openT, group = 1)) + geom_line() +
  labs(title = "") +
  xlab("Date") +
  ylab("Shrub - Open Temperature (C)") +
  scale_x_datetime(date_breaks = "2 week", labels = date_format("%b %d"))
p + facet_grid(site ~ .)

# plot shrub minus open RH by site
p <- ggplot(microsite_diff_df, aes(x=datetime, y=shrub.openRH, group = 1)) + geom_line() +
  labs(title = "") +
  xlab("Date") +
  ylab("Shrub RH (%) - Open RH (%)") +
  scale_x_datetime(date_breaks = "2 week", labels = date_format("%b %d"))
p + facet_grid(site ~ .)


# Scatter plots of climate space ------------------------------------------

p <- ggplot(microsite_diff_df, aes(x=mean_T_Open, y=mean_T_Shrub)) + geom_point() +
  labs(title = "") +
  xlab("Open Temperature (C)") +
  ylab("Shrub Temperature (C)") 
p + facet_grid(site ~ .) + geom_abline(aes(slope = 1, intercept=0), color = "blue")

p1 <- ggplot(microsite_diff_df, aes(x=mean_RH_Open, y=mean_RH_Shrub)) + geom_point() +
  labs(title = "") +
  xlab("Open RH (%)") +
  ylab("Shrub RH (%)") 
p1 + facet_grid(site ~ .) + geom_abline(aes(slope = 1, intercept=0), color = "blue")
```
